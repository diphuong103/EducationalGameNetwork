<?xml version="1.0" encoding="UTF-8"?>

<?import javafx.geometry.Insets?>
<?import javafx.scene.control.*?>
<?import javafx.scene.layout.*?>

<BorderPane xmlns="http://javafx.com/javafx/17"
            xmlns:fx="http://javafx.com/fxml/1"
            fx:controller="com.edugame.server.controller.ServerViewController"
            stylesheets="@../css/server-style.css"
            styleClass="root-pane">

    <!-- Top: Header Bar -->
    <top>
        <HBox styleClass="header-bar" spacing="15">
            <padding>
                <Insets top="20" right="25" bottom="20" left="25"/>
            </padding>

            <VBox spacing="5" HBox.hgrow="ALWAYS">
                <Label text="ðŸŽ® MATH ADVENTURE SERVER" styleClass="header-title"/>
                <Label fx:id="serverStatusLabel" text="â— Server Running" styleClass="status-label"/>
            </VBox>

            <VBox alignment="CENTER_RIGHT" spacing="8">
                <HBox spacing="15" alignment="CENTER_RIGHT">
                    <VBox alignment="CENTER" spacing="3" styleClass="stat-box">
                        <Label text="CONNECTIONS" styleClass="stat-label"/>
                        <Label fx:id="connectionsLabel" text="0" styleClass="stat-value"/>
                    </VBox>

                    <VBox alignment="CENTER" spacing="3" styleClass="stat-box">
                        <Label text="ROOMS" styleClass="stat-label"/>
                        <Label fx:id="roomsLabel" text="0" styleClass="stat-value"/>
                    </VBox>

                    <VBox alignment="CENTER" spacing="3" styleClass="stat-box">
                        <Label text="PLAYERS" styleClass="stat-label"/>
                        <Label fx:id="playersLabel" text="0" styleClass="stat-value"/>
                    </VBox>
                </HBox>

                <HBox spacing="10">
                    <Button fx:id="startButton" text="â–¶ Start" styleClass="btn-success" onAction="#handleStart"/>
                    <Button fx:id="stopButton" text="â¸ Stop" styleClass="btn-danger" onAction="#handleStop" disable="true"/>
                    <Button fx:id="questionBankButton" text="ðŸ“ Questions" styleClass="btn-primary" onAction="#handleOpenQuestionBank"/>
                </HBox>
            </VBox>
        </HBox>
    </top>

    <!-- Center: Tab Content -->
    <center>
        <TabPane fx:id="mainTabPane" styleClass="main-tabs" tabClosingPolicy="UNAVAILABLE">

            <!-- Tab 1: Room Management -->
            <Tab text="ðŸ“¦ Room Management">
                <BorderPane styleClass="room-management-container">

                    <!-- Left: Room List -->
                    <left>
                        <VBox styleClass="room-list-panel" prefWidth="320" spacing="12">
                            <padding>
                                <Insets top="20" right="15" bottom="20" left="20"/>
                            </padding>

                            <!-- Header -->
                            <HBox alignment="CENTER_LEFT" spacing="10">
                                <Label text="Danh sÃ¡ch phÃ²ng" styleClass="panel-title"/>
                                <Region HBox.hgrow="ALWAYS"/>
                                <Label text="Tá»•ng sá»‘ phÃ²ng: " styleClass="info-text"/>
                                <Label fx:id="totalRoomsLabel" text="0" styleClass="info-value-accent"/>
                            </HBox>

                            <HBox alignment="CENTER_LEFT" spacing="8">
                                <Label text="Äang chÆ¡i: " styleClass="info-text-sm"/>
                                <Label fx:id="playingRoomsLabel" text="0" styleClass="status-playing"/>
                                <Region prefWidth="10"/>
                                <Label text="Chá»: " styleClass="info-text-sm"/>
                                <Label fx:id="waitingRoomsLabel" text="0" styleClass="status-waiting"/>
                            </HBox>

                            <Separator/>

                            <!-- Refresh Button -->
                            <Button text="ðŸ”„ LÃ m má»›i" styleClass="btn-refresh-rooms"
                                    onAction="#handleRefreshRooms" maxWidth="Infinity"/>

                            <!-- Room List ScrollPane -->
                            <ScrollPane fitToWidth="true" VBox.vgrow="ALWAYS"
                                        styleClass="room-list-scroll">
                                <VBox fx:id="roomListContainer" spacing="10" styleClass="room-cards-container"/>
                            </ScrollPane>
                        </VBox>
                    </left>

                    <!-- Right: Room Details & Progress -->
                    <center>
                        <VBox styleClass="room-detail-panel" spacing="20">
                            <padding>
                                <Insets top="20" right="20" bottom="20" left="20"/>
                            </padding>

                            <!-- Room Header -->
                            <HBox alignment="CENTER_LEFT" spacing="15" styleClass="room-header">
                                <VBox spacing="5" HBox.hgrow="ALWAYS">
                                    <Label fx:id="selectedRoomTitle" text="Chá»n má»™t phÃ²ng Ä‘á»ƒ xem chi tiáº¿t"
                                           styleClass="room-title"/>
                                    <HBox spacing="10" alignment="CENTER_LEFT">
                                        <Label fx:id="roomStatusBadge" text="WAITING"
                                               styleClass="status-badge,status-waiting"/>
                                        <Label fx:id="roomIdLabel" text="#" styleClass="room-id-text"/>
                                    </HBox>
                                </VBox>
                                <Button fx:id="closeRoomButton" text="âœ–" styleClass="btn-close-detail"
                                        onAction="#handleCloseRoom" visible="false"/>
                            </HBox>

                            <Separator/>

                            <!-- Empty State -->
                            <VBox fx:id="emptyState" alignment="CENTER" spacing="20" VBox.vgrow="ALWAYS">
                                <Region VBox.vgrow="ALWAYS"/>
                                <Label text="ðŸ“¦" style="-fx-font-size: 64px; -fx-opacity: 0.5;"/>
                                <VBox alignment="CENTER" spacing="8">
                                    <Label text="ChÆ°a chá»n phÃ²ng nÃ o" styleClass="empty-title"/>
                                    <Label text="Nháº¥p vÃ o phÃ²ng á»Ÿ danh sÃ¡ch bÃªn trÃ¡i Ä‘á»ƒ xem chi tiáº¿t"
                                           styleClass="empty-subtitle"/>
                                </VBox>
                                <Region VBox.vgrow="ALWAYS"/>
                            </VBox>

                            <!-- Room Content (Hidden by default) -->
                            <VBox fx:id="roomContent" spacing="20" VBox.vgrow="ALWAYS" visible="false">

                                <!-- Room Info Grid -->
                                <GridPane fx:id="roomInfoGrid" styleClass="room-info-grid"
                                          hgap="20" vgap="12">
                                    <columnConstraints>
                                        <ColumnConstraints percentWidth="50"/>
                                        <ColumnConstraints percentWidth="50"/>
                                    </columnConstraints>

                                    <!-- Row 1 -->
                                    <VBox spacing="5" GridPane.columnIndex="0" GridPane.rowIndex="0">
                                        <Label text="Host" styleClass="info-label"/>
                                        <HBox spacing="8" alignment="CENTER_LEFT">
                                            <Label text="ðŸ‘¤" style="-fx-font-size: 16px;"/>
                                            <Label fx:id="hostLabel" text="MathKing99" styleClass="info-value"/>
                                        </HBox>
                                    </VBox>

                                    <VBox spacing="5" GridPane.columnIndex="1" GridPane.rowIndex="0">
                                        <Label text="MÃ´n há»c" styleClass="info-label"/>
                                        <HBox spacing="8" alignment="CENTER_LEFT">
                                            <Label fx:id="subjectIconLabel" text="ðŸ”¢" style="-fx-font-size: 16px;"/>
                                            <Label fx:id="subjectLabel" text="ToÃ¡n" styleClass="info-value"/>
                                        </HBox>
                                    </VBox>

                                    <!-- Row 2 -->
                                    <VBox spacing="5" GridPane.columnIndex="0" GridPane.rowIndex="1">
                                        <Label text="Äá»™ khÃ³" styleClass="info-label"/>
                                        <Label fx:id="difficultyLabel" text="Trung bÃ¬nh" styleClass="difficulty-badge"/>
                                    </VBox>

                                    <VBox spacing="5" GridPane.columnIndex="1" GridPane.rowIndex="1">
                                        <Label text="Sá»‘ ngÆ°á»i chÆ¡i" styleClass="info-label"/>
                                        <HBox spacing="8" alignment="CENTER_LEFT">
                                            <Label text="ðŸ‘¥" style="-fx-font-size: 16px;"/>
                                            <Label fx:id="playerCountLabel" text="3/4" styleClass="info-value"/>
                                        </HBox>
                                    </VBox>
                                </GridPane>

                                <Separator/>

                                <!-- Progress Section -->
                                <VBox spacing="15" styleClass="progress-section">
                                    <HBox alignment="CENTER_LEFT" spacing="10">
                                        <Label text="ðŸ“Š Tiáº¿n Ä‘á»™ tráº­n Ä‘áº¥u" styleClass="section-title"/>
                                        <Region HBox.hgrow="ALWAYS"/>
                                        <Label fx:id="currentQuestionLabel" text="CÃ¢u 5/10" styleClass="progress-text"/>
                                    </HBox>

                                    <!-- Progress Bar -->
                                    <VBox spacing="8">
                                        <ProgressBar fx:id="gameProgressBar" progress="0.5"
                                                     maxWidth="Infinity" prefHeight="12"
                                                     styleClass="game-progress-bar"/>
                                        <HBox alignment="CENTER_LEFT" spacing="15">
                                            <Label text="â±ï¸" style="-fx-font-size: 14px;"/>
                                            <Label fx:id="timeRemainingLabel" text="30s cÃ²n láº¡i"
                                                   styleClass="time-text"/>
                                        </HBox>
                                    </VBox>

                                    <!-- Game Stats -->
                                    <GridPane hgap="15" vgap="10" styleClass="stats-grid">
                                        <columnConstraints>
                                            <ColumnConstraints percentWidth="33.33"/>
                                            <ColumnConstraints percentWidth="33.33"/>
                                            <ColumnConstraints percentWidth="33.33"/>
                                        </columnConstraints>

                                        <VBox alignment="CENTER" spacing="5" styleClass="stat-card"
                                              GridPane.columnIndex="0" GridPane.rowIndex="0">
                                            <Label text="ðŸŽ¯" style="-fx-font-size: 20px;"/>
                                            <Label fx:id="correctAnswersLabel" text="12" styleClass="stat-value"/>
                                            <Label text="ÄÃºng" styleClass="stat-label"/>
                                        </VBox>

                                        <VBox alignment="CENTER" spacing="5" styleClass="stat-card"
                                              GridPane.columnIndex="1" GridPane.rowIndex="0">
                                            <Label text="âŒ" style="-fx-font-size: 20px;"/>
                                            <Label fx:id="wrongAnswersLabel" text="3" styleClass="stat-value"/>
                                            <Label text="Sai" styleClass="stat-label"/>
                                        </VBox>

                                        <VBox alignment="CENTER" spacing="5" styleClass="stat-card"
                                              GridPane.columnIndex="2" GridPane.rowIndex="0">
                                            <Label text="â­ï¸" style="-fx-font-size: 20px;"/>
                                            <Label fx:id="skippedLabel" text="1" styleClass="stat-value"/>
                                            <Label text="Bá» qua" styleClass="stat-label"/>
                                        </VBox>
                                    </GridPane>
                                </VBox>

                                <Separator/>

                                <!-- Players in Room -->
                                <VBox spacing="12" fx:id="playersSection">
                                    <Label text="ðŸ‘¥ NgÆ°á»i chÆ¡i trong phÃ²ng" styleClass="section-title"/>
                                    <ScrollPane fitToWidth="true" prefHeight="200"
                                                styleClass="players-scroll">
                                        <VBox fx:id="playerListContainer" spacing="8"/>
                                    </ScrollPane>
                                </VBox>

                                <Separator/>

                                <!-- Admin Actions -->
                                <VBox spacing="12" fx:id="adminActionsSection">
                                    <Label text="âš™ï¸ HÃ nh Ä‘á»™ng quáº£n trá»‹" styleClass="section-title"/>

                                    <GridPane hgap="10" vgap="10">
                                        <columnConstraints>
                                            <ColumnConstraints percentWidth="50"/>
                                            <ColumnConstraints percentWidth="50"/>
                                        </columnConstraints>

                                        <Button fx:id="pauseButton" text="â¸ï¸ Táº¡m dá»«ng"
                                                styleClass="btn-warning" maxWidth="Infinity"
                                                onAction="#handlePauseGame"
                                                GridPane.columnIndex="0" GridPane.rowIndex="0"/>

                                        <Button fx:id="resumeButton" text="â–¶ï¸ Tiáº¿p tá»¥c"
                                                styleClass="btn-success" maxWidth="Infinity"
                                                onAction="#handleResumeGame" visible="false"
                                                GridPane.columnIndex="0" GridPane.rowIndex="0"/>

                                        <Button fx:id="announceButton" text="ðŸ“¢ ThÃ´ng bÃ¡o"
                                                styleClass="btn-primary" maxWidth="Infinity"
                                                onAction="#handleAnnounce"
                                                GridPane.columnIndex="1" GridPane.rowIndex="0"/>

                                        <Button fx:id="kickPlayerButton" text="ðŸ‘Š Kick ngÆ°á»i chÆ¡i"
                                                styleClass="btn-warning-outline" maxWidth="Infinity"
                                                onAction="#handleKickPlayer"
                                                GridPane.columnIndex="0" GridPane.rowIndex="1"/>

                                        <Button fx:id="destroyButton" text="ðŸ’£ Há»§y phÃ²ng"
                                                styleClass="btn-danger" maxWidth="Infinity"
                                                onAction="#handleDestroyRoom"
                                                GridPane.columnIndex="1" GridPane.rowIndex="1"/>
                                    </GridPane>
                                </VBox>
                            </VBox>
                        </VBox>
                    </center>

                </BorderPane>
            </Tab>

            <!-- Tab 2: User Management -->
            <Tab text="ðŸ‘¥ User Management">
                <BorderPane styleClass="user-management-container">

                    <!-- Top Toolbar -->
                    <top>
                        <VBox spacing="15">
                            <padding>
                                <Insets top="15" right="15" bottom="15" left="15"/>
                            </padding>

                            <!-- Title and Stats -->
                            <HBox spacing="10" alignment="CENTER_LEFT">
                                <Label text="USER MANAGEMENT" styleClass="section-title"/>
                                <Region HBox.hgrow="ALWAYS"/>
                                <Label fx:id="totalUsersLabel" text="Total: 0 users" styleClass="info-value"/>
                            </HBox>

                            <!-- Search and Actions -->
                            <HBox spacing="10" alignment="CENTER_LEFT">
                                <TextField fx:id="userSearchField" promptText="ðŸ” Search by username or email..."
                                           prefWidth="300" styleClass="search-field"/>
                                <Button text="Search" styleClass="btn-primary" onAction="#handleSearchUsers"/>
                                <Button text="ðŸ”„ Refresh" styleClass="btn-secondary" onAction="#handleRefreshUsers"/>
                                <Region HBox.hgrow="ALWAYS"/>
                                <Button text="âž• Add User" styleClass="btn-success" onAction="#handleAddUser"/>
                            </HBox>

                            <!-- Filters -->
                            <HBox spacing="15" alignment="CENTER_LEFT" styleClass="filter-bar">
                                <Label text="Filter:" styleClass="filter-label"/>
                                <ComboBox fx:id="userStatusFilter" promptText="All Status" prefWidth="120"/>
                                <ComboBox fx:id="userSortFilter" promptText="Sort By" prefWidth="150"/>
                                <Region HBox.hgrow="ALWAYS"/>
                                <Label fx:id="filteredCountLabel" text="Showing: 0 users" styleClass="filter-label"/>
                            </HBox>
                        </VBox>
                    </top>

                    <!-- Center: User Table -->
                    <center>
                        <TableView fx:id="userTable" styleClass="data-table">
                            <padding>
                                <Insets top="0" right="15" bottom="15" left="15"/>
                            </padding>
                        </TableView>
                    </center>
                </BorderPane>
            </Tab>

            <!-- Tab 3: Server Console -->
            <Tab text="ðŸ–¥ï¸ Console">
                <VBox spacing="10" styleClass="console-container">
                    <padding>
                        <Insets top="15" right="15" bottom="15" left="15"/>
                    </padding>

                    <HBox alignment="CENTER_LEFT" spacing="10">
                        <Label text="SERVER LOG" styleClass="section-title"/>
                        <Region HBox.hgrow="ALWAYS"/>
                        <Button text="ðŸ—‘ï¸ Clear" styleClass="btn-secondary" onAction="#handleClearLog"/>
                    </HBox>

                    <TextArea fx:id="consoleArea" editable="false" wrapText="true"
                              VBox.vgrow="ALWAYS" styleClass="console-text"/>
                </VBox>
            </Tab>

            <!-- Tab 4: Statistics -->
            <Tab text="ðŸ“Š Statistics">
                <ScrollPane fitToWidth="true" styleClass="stats-scroll">
                    <VBox spacing="20" styleClass="stats-container">
                        <padding>
                            <Insets top="20" right="20" bottom="20" left="20"/>
                        </padding>

                        <Label text="SERVER STATISTICS" styleClass="section-title"/>

                        <GridPane hgap="20" vgap="20" styleClass="stats-grid">
                            <!-- Row 1 -->
                            <VBox styleClass="stat-card" GridPane.columnIndex="0" GridPane.rowIndex="0">
                                <Label text="Total Connections" styleClass="stat-card-title"/>
                                <Label fx:id="totalConnectionsLabel" text="0" styleClass="stat-card-value"/>
                                <Label text="Since server start" styleClass="stat-card-subtitle"/>
                            </VBox>

                            <VBox styleClass="stat-card" GridPane.columnIndex="1" GridPane.rowIndex="0">
                                <Label text="Total Games" styleClass="stat-card-title"/>
                                <Label fx:id="totalGamesLabel" text="0" styleClass="stat-card-value"/>
                                <Label text="Completed matches" styleClass="stat-card-subtitle"/>
                            </VBox>

                            <VBox styleClass="stat-card" GridPane.columnIndex="2" GridPane.rowIndex="0">
                                <Label text="Peak Players" styleClass="stat-card-title"/>
                                <Label fx:id="peakPlayersLabel" text="0" styleClass="stat-card-value"/>
                                <Label text="Maximum concurrent" styleClass="stat-card-subtitle"/>
                            </VBox>

                            <!-- Row 2 -->
                            <VBox styleClass="stat-card" GridPane.columnIndex="0" GridPane.rowIndex="1">
                                <Label text="Uptime" styleClass="stat-card-title"/>
                                <Label fx:id="uptimeLabel" text="00:00:00" styleClass="stat-card-value"/>
                                <Label text="Server running time" styleClass="stat-card-subtitle"/>
                            </VBox>

                            <VBox styleClass="stat-card" GridPane.columnIndex="1" GridPane.rowIndex="1">
                                <Label text="Messages Sent" styleClass="stat-card-title"/>
                                <Label fx:id="messagesSentLabel" text="0" styleClass="stat-card-value"/>
                                <Label text="Total packets" styleClass="stat-card-subtitle"/>
                            </VBox>

                            <VBox styleClass="stat-card" GridPane.columnIndex="2" GridPane.rowIndex="1">
                                <Label text="Average Response" styleClass="stat-card-title"/>
                                <Label fx:id="avgResponseLabel" text="0ms" styleClass="stat-card-value"/>
                                <Label text="Server latency" styleClass="stat-card-subtitle"/>
                            </VBox>
                        </GridPane>
                    </VBox>
                </ScrollPane>
            </Tab>

        </TabPane>
    </center>

    <!-- Bottom: Status Bar -->
    <bottom>
        <HBox styleClass="status-bar" spacing="20" alignment="CENTER_LEFT">
            <padding>
                <Insets top="10" right="20" bottom="10" left="20"/>
            </padding>

            <Label fx:id="portLabel" text="Port: 8888"/>
            <Separator orientation="VERTICAL"/>
            <Label fx:id="uptimeStatusLabel" text="Uptime: 00:00:00"/>
            <Separator orientation="VERTICAL"/>
            <Label fx:id="memoryLabel" text="Memory: 0 MB"/>
            <Region HBox.hgrow="ALWAYS"/>
            <Label fx:id="timestampLabel" text="Last update: --:--:--" styleClass="timestamp-label"/>
        </HBox>
    </bottom>

</BorderPane>